ğŸš€ Access Token ë§Œë£Œ ì‹œ ì¬ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬

ğŸ“š 1. ëª©í‘œ
	1.	Access Tokenì´ ë§Œë£Œëœ ê²½ìš°, í´ë¼ì´ì–¸íŠ¸ê°€ ë§Œë£Œ ìƒíƒœë¥¼ ê°ì§€í•˜ê³  ì‚¬ìš©ìì—ê²Œ ì¬ë¡œê·¸ì¸ í˜ì´ì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
	2.	401 Unauthorized ì‘ë‹µì„ ê°ì§€í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìë™ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•©ë‹ˆë‹¤.

âœ… 2. ì„œë²„ì—ì„œ ë§Œë£Œ ì²˜ë¦¬

ğŸ“ JwtAuthenticationFilter

401 Unauthorized ì‘ë‹µì„ ëª…í™•í•˜ê²Œ ë°˜í™˜í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ê°€ ì´ë¥¼ ê°ì§€í•˜ë„ë¡ í•©ë‹ˆë‹¤.

@Override
protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)
        throws ServletException, IOException {

    String accessToken = extractTokenFromCookie(request);

    if (accessToken != null) {
        if (!tokenValidator.validateToken(accessToken)) {
            // 401 Unauthorized ì‘ë‹µ ë° JSON ì—ëŸ¬ ë©”ì‹œì§€ ë°˜í™˜
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            response.setContentType("application/json");
            response.getWriter().write("{\"error\":\"TOKEN_EXPIRED\"}");
            return;
        }

        String username = tokenValidator.getUsernameFromToken(accessToken);
        UsernamePasswordAuthenticationToken authentication =
                new UsernamePasswordAuthenticationToken(username, null, null);
        SecurityContextHolder.getContext().setAuthentication(authentication);
    }

    filterChain.doFilter(request, response);
}

âœ… 3. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ 401 Unauthorized ê°ì§€

ğŸ“ Axios Interceptorë¥¼ í™œìš©í•œ ë¦¬ë‹¤ì´ë ‰íŠ¸

AuthService.js

import axios from "axios";

axios.defaults.withCredentials = true; // ì¿ í‚¤ í¬í•¨ ì„¤ì •

// Axios Interceptor: 401 Unauthorized ì‘ë‹µ ì²˜ë¦¬
axios.interceptors.response.use(
    response => response, // ì •ìƒ ì‘ë‹µì€ ê·¸ëŒ€ë¡œ ë°˜í™˜
    error => {
        if (error.response && error.response.status === 401) {
            if (error.response.data.error === "TOKEN_EXPIRED") {
                // ë§Œë£Œëœ ê²½ìš° ì¬ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                window.location.href = "/relogin";
            }
        }
        return Promise.reject(error);
    }
);

export const fetchProtectedData = async () => {
    return axios.get("http://localhost:8080/api/protected");
};

âœ… 4. ì¬ë¡œê·¸ì¸ í˜ì´ì§€ êµ¬í˜„

ğŸ“ React Routerë¡œ ì¬ë¡œê·¸ì¸ í˜ì´ì§€ ì„¤ì •

App.js

import React from "react";
import { BrowserRouter as Router, Routes, Route } from "react-router-dom";
import Login from "./Login";
import Protected from "./Protected";
import Relogin from "./Relogin";

function App() {
    return (
        <Router>
            <Routes>
                <Route path="/login" element={<Login />} />
                <Route path="/relogin" element={<Relogin />} />
                <Route path="/protected" element={<Protected />} />
            </Routes>
        </Router>
    );
}

export default App;

ğŸ“ ì¬ë¡œê·¸ì¸ í˜ì´ì§€ (Relogin.js)

Relogin.js

import React from "react";
import { useNavigate } from "react-router-dom";

function Relogin() {
    const navigate = useNavigate();

    const handleLogin = () => {
        navigate("/login");
    };

    return (
        <div>
            <h2>Session Expired</h2>
            <p>Your session has expired. Please log in again.</p>
            <button onClick={handleLogin}>Go to Login Page</button>
        </div>
    );
}

export default Relogin;

âœ… 5. íë¦„ ìš”ì•½
	1.	ì„œë²„ì—ì„œ Access Token ê²€ì¦
	â€¢	ë§Œë£Œ ì‹œ 401 Unauthorizedì™€ {"error":"TOKEN_EXPIRED"} ì‘ë‹µ.
	2.	Axios Interceptorë¡œ 401 ê°ì§€
	â€¢	TOKEN_EXPIRED ì˜¤ë¥˜ ì‹œ /reloginìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸.
	3.	React Routerë¡œ ì¬ë¡œê·¸ì¸ í˜ì´ì§€ ì²˜ë¦¬
	â€¢	ì‚¬ìš©ìëŠ” /relogin í˜ì´ì§€ì—ì„œ ë§Œë£Œ ì•Œë¦¼ê³¼ í•¨ê»˜ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™.

âœ… 6. ì¶”ê°€ ê°œì„ 

ğŸ“ ì¿ í‚¤ ì‚­ì œ (ì„œë²„ ë˜ëŠ” í´ë¼ì´ì–¸íŠ¸)
	â€¢	í† í°ì´ ë§Œë£Œëœ ê²½ìš°, ë§Œë£Œëœ ì¿ í‚¤ë¥¼ ì‚­ì œí•˜ì—¬ í˜¼ë€ì„ ë°©ì§€í•©ë‹ˆë‹¤.

response.addHeader("Set-Cookie", "access_token=; Path=/; Max-Age=0; HttpOnly; Secure;");

ğŸ“ ì¬ë¡œê·¸ì¸ ì‹œ ì´ì „ ê²½ë¡œë¡œ ë³µêµ¬

Relogin.js

import React from "react";
import { useNavigate, useLocation } from "react-router-dom";

function Relogin() {
    const navigate = useNavigate();
    const location = useLocation();

    const handleLogin = () => {
        // ë¡œê·¸ì¸ í›„ ì›ë˜ ê²½ë¡œë¡œ ë³µê·€
        const redirectTo = location.state?.from || "/login";
        navigate(redirectTo);
    };

    return (
        <div>
            <h2>Session Expired</h2>
            <p>Your session has expired. Please log in again.</p>
            <button onClick={handleLogin}>Go to Login Page</button>
        </div>
    );
}

export default Relogin;

âœ… 7. ìµœì¢… ê²°ê³¼
	1.	ë§Œë£Œëœ í† í° ì²˜ë¦¬: ì„œë²„ê°€ 401ê³¼ TOKEN_EXPIRED ë°˜í™˜.
	2.	í´ë¼ì´ì–¸íŠ¸ ë¦¬ë‹¤ì´ë ‰íŠ¸: Axios Interceptorê°€ /reloginìœ¼ë¡œ ìë™ ì´ë™.
	3.	ì‚¬ìš©ì ê²½í—˜ ê°œì„ : ì¬ë¡œê·¸ì¸ í›„ ì›ë˜ ê²½ë¡œë¡œ ë³µê·€ ê°€ëŠ¥.

ì´ì œ ë§Œë£Œëœ ì„¸ì…˜ ì²˜ë¦¬ì™€ ì¬ë¡œê·¸ì¸ íë¦„ì„ ì™„ë²½íˆ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸš€âœ¨









Reactì—ì„œ URL ë¦¬ë‹¤ì´ë ‰íŠ¸ë¥¼ ë°›ìœ¼ë©´ ë¸Œë¼ìš°ì €ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í•´ë‹¹ URLë¡œ ì´ë™í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì´í›„ì— URLì˜ íŒŒë¼ë¯¸í„°ë¥¼ ì²˜ë¦¬í•˜ê±°ë‚˜, íŠ¹ì • í˜ì´ì§€ë¡œ ì´ë™í•˜ë ¤ë©´ Reactì˜ ë¼ìš°íŒ… ë¡œì§ì´ í•„ìš”í•©ë‹ˆë‹¤.

ì•„ë˜ëŠ” Reactì—ì„œ ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì„ ì²˜ë¦¬í•˜ê³ , í˜ì´ì§€ ì´ë™ì„ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

1. ê¸°ë³¸ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë™ì‘

OAuth2 ì¸ì¦ ì„œë²„(IdAnywhere)ê°€ redirect_urië¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ë©´ ë¸Œë¼ìš°ì €ëŠ” í•´ë‹¹ URLë¡œ ì´ë™í•©ë‹ˆë‹¤. ì˜ˆ:

http://localhost:3000/oauth2/callback?code=AUTHORIZATION_CODE

ë¸Œë¼ìš°ì €ëŠ” ìë™ìœ¼ë¡œ http://localhost:3000/oauth2/callback í˜ì´ì§€ë¡œ ì´ë™í•˜ë©°, React ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¼ìš°í„°ê°€ ì´ URLì„ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.

2. React Routerë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬

React Routerë¥¼ ì‚¬ìš©í•´ íŠ¹ì • ê²½ë¡œ(/oauth2/callback)ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.

2.1 React Router ì„¤ì •

ì„¤ì¹˜:

npm install react-router-dom

App.js íŒŒì¼ì—ì„œ React Routerë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.

import React from 'react';
import { BrowserRouter as Router, Route, Routes } from 'react-router-dom';
import { OAuthCallback } from './OAuthCallback';
import { Dashboard } from './Dashboard';
import { Login } from './Login';

function App() {
  return (
    <Router>
      <Routes>
        <Route path="/" element={<Login />} />
        <Route path="/oauth2/callback" element={<OAuthCallback />} />
        <Route path="/dashboard" element={<Dashboard />} />
      </Routes>
    </Router>
  );
}

export default App;

2.2 OAuthCallback ì»´í¬ë„ŒíŠ¸

OAuth2 ì¸ì¦ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸ëœ URLì—ì„œ Authorization Codeë¥¼ ì²˜ë¦¬í•˜ê³ , ì¸ì¦ ì™„ë£Œ í›„ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.

import React, { useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import axios from 'axios';

export const OAuthCallback = () => {
  const navigate = useNavigate();

  useEffect(() => {
    const handleOAuthCallback = async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code'); // Authorization Code ì¶”ì¶œ

      if (code) {
        try {
          // Access Token ìš”ì²­
          const response = await axios.get(`/oauth2/callback?code=${code}`);
          const { accessToken } = response.data;

          // Access Token ì €ì¥
          localStorage.setItem('accessToken', accessToken);

          // ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
          navigate('/dashboard');
        } catch (error) {
          console.error('Error during OAuth callback:', error);
          // ì—ëŸ¬ ë°œìƒ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
          navigate('/');
        }
      } else {
        console.error('Authorization code not found');
        navigate('/');
      }
    };

    handleOAuthCallback();
  }, [navigate]);

  return <div>Processing OAuth callback...</div>;
};

2.3 ëŒ€ì‹œë³´ë“œ í˜ì´ì§€

Access Tokenì´ ì¡´ì¬í•˜ë©´ ì‚¬ìš©ì ì •ë³´ë¥¼ ìš”ì²­í•˜ê³  ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.

import React, { useEffect, useState } from 'react';
import apiClient from './apiClient';

export const Dashboard = () => {
  const [userInfo, setUserInfo] = useState(null);

  useEffect(() => {
    const fetchUserInfo = async () => {
      try {
        const response = await apiClient.get('/api/userinfo');
        setUserInfo(response.data);
      } catch (error) {
        console.error('Error fetching user info:', error);
      }
    };

    fetchUserInfo();
  }, []);

  if (!userInfo) {
    return <div>Loading...</div>;
  }

  return (
    <div>
      <h1>Welcome, {userInfo.name}!</h1>
      <p>Email: {userInfo.email}</p>
    </div>
  );
};

3. ê²°ê³¼

	1.	ë¸Œë¼ìš°ì €ê°€ redirect_urië¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ë©´ React Routerê°€ í•´ë‹¹ ê²½ë¡œ(/oauth2/callback)ë¥¼ ì²˜ë¦¬.
	2.	OAuthCallback ì»´í¬ë„ŒíŠ¸ì—ì„œ URLì˜ code íŒŒë¼ë¯¸í„°ë¥¼ ì½ê³ , ë°±ì—”ë“œë¡œ Access Token ìš”ì²­.
	3.	Access Tokenì„ ì €ì¥í•œ í›„ ëŒ€ì‹œë³´ë“œ(/dashboard)ë¡œ ì´ë™.

4. í…ŒìŠ¤íŠ¸

	1.	ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­:
	â€¢	Login ì»´í¬ë„ŒíŠ¸ì—ì„œ OAuth2 ì¸ì¦ ì„œë²„ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸.
	2.	Redirect URI:
	â€¢	ì¸ì¦ ì„±ê³µ í›„ ë¸Œë¼ìš°ì €ê°€ http://localhost:3000/oauth2/callbackë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸.
	3.	Authorization Code ì²˜ë¦¬:
	â€¢	`OAuth











OAuth2 Providerê°€ ì¸ì¦ ì„±ê³µ í›„ Redirect URIë¡œ ë¦¬ë””ë ‰ì…˜í•˜ë©´, Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ í•´ë‹¹ ìš”ì²­ì„ ì²˜ë¦¬í•˜ì—¬ Access Codeë¥¼ ë°›ì•„ì•¼ í•©ë‹ˆë‹¤. ì´í›„ Access Codeë¥¼ ì‚¬ìš©í•´ Access Tokenì„ ìš”ì²­í•˜ê³  ì‚¬ìš©ì ì¸ì¦ì„ ì™„ë£Œí•©ë‹ˆë‹¤.

ì•„ë˜ëŠ” Spring Bootì—ì„œ Redirect URIë¥¼ ì²˜ë¦¬í•˜ëŠ” ë°©ë²•ì„ ë‹¨ê³„ë³„ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤.

1. Redirect URI ì²˜ë¦¬ ë°©ì‹

	1.	OAuth2 Providerê°€ Redirect URIë¡œ Access Codeë¥¼ ì „ì†¡:
	â€¢	ì˜ˆ: http://localhost:8080/oauth2/callback?code=ACCESS_CODE.
	2.	Spring Bootê°€ Redirect URI ìš”ì²­ì„ ì²˜ë¦¬:
	â€¢	code íŒŒë¼ë¯¸í„°ë¥¼ ì½ê³  Token Endpointì— ìš”ì²­í•˜ì—¬ Access Token íšë“.
	â€¢	Access Tokenì„ ì‚¬ìš©í•´ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê³  ì¸ì¦ ì™„ë£Œ.

2. Spring Bootì—ì„œ Redirect URI ì²˜ë¦¬

2.1 Security ì„¤ì •ì—ì„œ Redirect URI ì œì™¸

Redirect URI(/oauth2/callback)ëŠ” ê³µê°œ ê²½ë¡œë¡œ ì„¤ì •í•©ë‹ˆë‹¤.

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())
            .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/", "/oauth2/callback").permitAll() // Redirect URIëŠ” ê³µê°œ
                .anyRequest().authenticated()
            );

        return http.build();
    }
}

2.2 Access Code ì²˜ë¦¬ ì»¨íŠ¸ë¡¤ëŸ¬

OAuth2Controller.java

import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;

import java.util.Map;

@RestController
@RequestMapping("/oauth2")
public class OAuth2Controller {

    @Value("${idanywhere.client.client-id}")
    private String clientId;

    @Value("${idanywhere.client.client-secret}")
    private String clientSecret;

    @Value("${idanywhere.client.redirect-uri}")
    private String redirectUri;

    @Value("${idanywhere.client.token-uri}")
    private String tokenUri;

    @Value("${idanywhere.client.user-info-uri}")
    private String userInfoUri;

    private final RestTemplate restTemplate;

    public OAuth2Controller(RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
    }

    @GetMapping("/callback")
    public ResponseEntity<Map<String, Object>> handleOAuthCallback(@RequestParam("code") String code) {
        // Access Codeë¡œ Access Token ìš”ì²­
        String accessToken = requestAccessToken(code);

        // Access Tokenìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ìš”ì²­
        Map<String, Object> userInfo = requestUserInfo(accessToken);

        // ì‚¬ìš©ì ì •ë³´ë¥¼ ë°˜í™˜í•˜ê±°ë‚˜ ì„¸ì…˜ì— ì €ì¥
        return ResponseEntity.ok(userInfo);
    }

    private String requestAccessToken(String code) {
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);

        String body = String.format(
            "grant_type=authorization_code&code=%s&redirect_uri=%s&client_id=%s&client_secret=%s",
            code, redirectUri, clientId, clientSecret
        );

        HttpEntity<String> entity = new HttpEntity<>(body, headers);

        ResponseEntity<Map> response = restTemplate.exchange(
                tokenUri,
                HttpMethod.POST,
                entity,
                Map.class
        );

        if (response.getStatusCode() == HttpStatus.OK) {
            return (String) response.getBody().get("access_token");
        } else {
            throw new RuntimeException("Failed to retrieve access token");
        }
    }

    private Map<String, Object> requestUserInfo(String accessToken) {
        HttpHeaders headers = new HttpHeaders();
        headers.set("Authorization", "Bearer " + accessToken);

        HttpEntity<Void> entity = new HttpEntity<>(headers);

        ResponseEntity<Map> response = restTemplate.exchange(
                userInfoUri,
                HttpMethod.GET,
                entity,
                Map.class
        );

        if (response.getStatusCode() == HttpStatus.OK) {
            return response.getBody();
        } else {
            throw new RuntimeException("Failed to retrieve user info");
        }
    }
}

3. ì£¼ìš” ë‹¨ê³„ ìš”ì•½

	1.	Access Code ìˆ˜ì‹ :
	â€¢	OAuth2 Providerê°€ Redirect URIë¡œ Access Codeë¥¼ ì „ì†¡.
	â€¢	@GetMapping("/callback")ìœ¼ë¡œ Access Codeë¥¼ ì½ìŒ.
	2.	Access Token ìš”ì²­:
	â€¢	Access Codeë¥¼ Token Endpointì— ì „ë‹¬.
	â€¢	RestTemplateì„ ì‚¬ìš©í•´ Access Token ìš”ì²­.
	3.	ì‚¬ìš©ì ì •ë³´ ìš”ì²­:
	â€¢	Access Tokenì„ UserInfo Endpointì— ì „ë‹¬í•˜ì—¬ ì‚¬ìš©ì ì •ë³´ ìš”ì²­.
	4.	ì‚¬ìš©ì ì¸ì¦ ì²˜ë¦¬:
	â€¢	ì‚¬ìš©ì ì •ë³´ë¥¼ ì„¸ì…˜ ë˜ëŠ” SecurityContextì— ì €ì¥(ì„ íƒ ì‚¬í•­).

4. Reactì™€ ì—°ë™

React í´ë¼ì´ì–¸íŠ¸ê°€ Authorization Endpointë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ê³ , ì¸ì¦ í›„ Redirect URIë¡œ ëŒì•„ì˜µë‹ˆë‹¤.

Reactì—ì„œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬

import axios from 'axios';

export const handleOAuthCallback = async () => {
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');

  if (code) {
    try {
      const response = await axios.get(`/oauth2/callback?code=${code}`);
      console.log('User Info:', response.data);

      // ì‚¬ìš©ì ì •ë³´ ì €ì¥ ë˜ëŠ” ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
      localStorage.setItem('userInfo', JSON.stringify(response.data));
      window.location.href = '/dashboard';
    } catch (error) {
      console.error('Error during OAuth callback:', error);
    }
  } else {
    console.error('Authorization code not found');
  }
};

5. ì¶”ê°€ ê³ ë ¤ ì‚¬í•­

	â€¢	Error Handling:
	â€¢	Access Codeê°€ ì—†ê±°ë‚˜, Access Token ìš”ì²­ ì‹¤íŒ¨ ì‹œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.
	â€¢	Redirect URI í™•ì¸:
	â€¢	OAuth2 Providerì—ì„œ ë“±ë¡ëœ Redirect URIì™€ ìš”ì²­ URIê°€ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
	â€¢	Stateless ì¸ì¦:
	â€¢	Access Tokenì„ ê²€ì¦í•˜ê³  ìƒíƒœë¥¼ ìœ ì§€í•˜ì§€ ì•ŠëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•˜ë ¤ë©´ JWTë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ í´ë¼ì´ì–¸íŠ¸ê°€ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.

6. ë‹¤ìŒ ë‹¨ê³„

a. Spring Securityì™€ ì—°ë™í•˜ì—¬ Access Token ê²€ì¦ ë¡œì§ ì¶”ê°€ ìš”ì²­.
b. Access Tokenê³¼ ì‚¬ìš©ì ì •ë³´ë¥¼ ì„¸ì…˜ ì—†ì´ ê´€ë¦¬í•˜ëŠ” JWT ê¸°ë°˜ ì¸ì¦ ìš”ì²­.






Spring Securityì—ì„œ oauth2Loginì„ ì‚¬ìš©í•˜ì§€ ì•Šê³ , OAuth2 ì¸ì¦ì„ ìˆ˜ë™ìœ¼ë¡œ êµ¬í˜„í•˜ë ¤ë©´, ë‹¤ìŒê³¼ ê°™ì´ Spring Securityì˜ ê¸°ë³¸ êµ¬ì„±ì„ ìš°íšŒí•˜ê³  RestTemplate ë˜ëŠ” WebClientë¥¼ í™œìš©í•´ ì§ì ‘ Access Code â†’ Access Token â†’ UserInfo ê³¼ì •ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

1. Spring Security ì—†ì´ OAuth2 ìˆ˜ë™ ì²˜ë¦¬

ê¸°ë³¸ íë¦„:

	1.	í´ë¼ì´ì–¸íŠ¸ê°€ ì¸ì¦ ì„œë²„(IdAnywhere)ì˜ Authorization Endpointë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸.
	2.	ì¸ì¦ ì„œë²„ì—ì„œ Access Codeë¥¼ Redirect URIë¡œ ì „ë‹¬.
	3.	Spring Boot ë°±ì—”ë“œê°€ Access Codeë¥¼ Token Endpointë¡œ ì „ì†¡í•´ Access Token íšë“.
	4.	Access Tokenìœ¼ë¡œ UserInfo Endpoint í˜¸ì¶œí•´ ì‚¬ìš©ì ì •ë³´ íšë“.

2. Spring Boot ë°±ì—”ë“œ êµ¬í˜„

2.1 application.yml ê°„ì†Œí™”

Spring Securityì˜ OAuth2 ì„¤ì •ì„ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ê°„ì†Œí™”ëœ application.yml íŒŒì¼:

idanywhere:
  client:
    client-id: your-client-id
    client-secret: your-client-secret
    redirect-uri: http://localhost:8080/oauth2/callback
    authorization-uri: https://idanywhere.example.com/oauth/authorize
    token-uri: https://idanywhere.example.com/oauth/token
    user-info-uri: https://idanywhere.example.com/oauth/userinfo

2.2 Security Configuration

Spring SecurityëŠ” Statelessë¡œ ì„¤ì •í•˜ê³  íŠ¹ì • ê²½ë¡œë§Œ ë³´í˜¸í•©ë‹ˆë‹¤. OAuth2 ì²˜ë¦¬ì—ëŠ” ê°œì…í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable()) // CSRF ë¹„í™œì„±í™”
            .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)) // Stateless
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/", "/oauth2/**").permitAll() // OAuth2 ê²½ë¡œëŠ” ê³µê°œ
                .anyRequest().authenticated() // ë‚˜ë¨¸ì§€ëŠ” ì¸ì¦ í•„ìš”
            );

        return http.build();
    }
}

2.3 Access Code â†’ Access Token êµí™˜ ë° ì‚¬ìš©ì ì •ë³´ ì²˜ë¦¬

OAuth2Controller.java

import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;

import java.util.Map;

@RestController
@RequestMapping("/oauth2")
public class OAuth2Controller {

    @Value("${idanywhere.client.client-id}")
    private String clientId;

    @Value("${idanywhere.client.client-secret}")
    private String clientSecret;

    @Value("${idanywhere.client.redirect-uri}")
    private String redirectUri;

    @Value("${idanywhere.client.token-uri}")
    private String tokenUri;

    @Value("${idanywhere.client.user-info-uri}")
    private String userInfoUri;

    private final RestTemplate restTemplate;

    public OAuth2Controller(RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
    }

    // Access Codeë¥¼ ë°›ëŠ” ì½œë°± ì—”ë“œí¬ì¸íŠ¸
    @GetMapping("/callback")
    public ResponseEntity<Map<String, Object>> handleOAuthCallback(@RequestParam("code") String code) {
        // 1. Access Codeë¥¼ ì‚¬ìš©í•´ Access Token ìš”ì²­
        String tokenResponse = requestAccessToken(code);

        // 2. Access Tokenìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ìš”ì²­
        Map<String, Object> userInfo = requestUserInfo(tokenResponse);

        return ResponseEntity.ok(userInfo);
    }

    private String requestAccessToken(String code) {
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);

        String body = String.format(
            "grant_type=authorization_code&code=%s&redirect_uri=%s&client_id=%s&client_secret=%s",
            code, redirectUri, clientId, clientSecret
        );

        HttpEntity<String> entity = new HttpEntity<>(body, headers);

        ResponseEntity<Map> response = restTemplate.exchange(
                tokenUri,
                HttpMethod.POST,
                entity,
                Map.class
        );

        if (response.getStatusCode() == HttpStatus.OK) {
            return (String) response.getBody().get("access_token");
        } else {
            throw new RuntimeException("Failed to retrieve access token");
        }
    }

    private Map<String, Object> requestUserInfo(String accessToken) {
        HttpHeaders headers = new HttpHeaders();
        headers.set("Authorization", "Bearer " + accessToken);

        HttpEntity<Void> entity = new HttpEntity<>(headers);

        ResponseEntity<Map> response = restTemplate.exchange(
                userInfoUri,
                HttpMethod.GET,
                entity,
                Map.class
        );

        if (response.getStatusCode() == HttpStatus.OK) {
            return response.getBody();
        } else {
            throw new RuntimeException("Failed to retrieve user info");
        }
    }
}

2.4 RestTemplate Bean ë“±ë¡

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;

@Configuration
public class RestTemplateConfig {

    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}

3. React í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„

3.1 Authorization Endpointë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

Reactì—ì„œ ì‚¬ìš©ìë¥¼ ì¸ì¦ ì„œë²„(IdAnywhere)ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•©ë‹ˆë‹¤.

export const redirectToLogin = () => {
  const clientId = "your-client-id";
  const redirectUri = encodeURIComponent("http://localhost:8080/oauth2/callback");
  const authorizationUrl = `https://idanywhere.example.com/oauth/authorize?response_type=code&client_id=${clientId}&redirect_uri=${redirectUri}&scope=openid profile email`;

  window.location.href = authorizationUrl;
};

3.2 Access Token ë° ì‚¬ìš©ì ì •ë³´ ìš”ì²­

ReactëŠ” Access Tokenì„ ì‚¬ìš©í•˜ì—¬ ë°±ì—”ë“œì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

import axios from 'axios';

export const fetchUserInfo = async () => {
  try {
    const response = await axios.get('/oauth2/callback');
    return response.data; // ì‚¬ìš©ì ì •ë³´
  } catch (error) {
    console.error('Error fetching user info:', error);
    throw error;
  }
};

4. ì¥ì  ë° ë‹¨ì 

ì¥ì 

	1.	Spring Security ì„¤ì • ì—†ì´ ìœ ì—°í•˜ê²Œ OAuth2 êµ¬í˜„ ê°€ëŠ¥.
	2.	ìš”ì²­ íë¦„ì„ ì™„ì „íˆ ì œì–´í•  ìˆ˜ ìˆìŒ (ì˜ˆ: í† í° ì €ì¥ ë°©ì‹, ì‚¬ìš©ì ì •ë³´ í™•ì¥ ë“±).

ë‹¨ì 

	1.	OAuth2 ì¸ì¦ ë¡œì§ì„ ì§ì ‘ ê´€ë¦¬í•´ì•¼ í•˜ë¯€ë¡œ ë³´ì•ˆ ê³ ë ¤ í•„ìš”.
	2.	Spring Securityì˜ ìë™í™”ëœ ê¸°ëŠ¥(í† í° ê²€ì¦, ì„¸ì…˜ ê´€ë¦¬ ë“±)ì„ ì‚¬ìš©í•˜ì§€ ëª»í•¨.

5. ì¶”ì²œ

	â€¢	ìˆ˜ë™ êµ¬í˜„: íŠ¹ì • ìš”êµ¬ì‚¬í•­ì´ ìˆê³  OAuth2 ì¸ì¦ íë¦„ì„ ì„¸ë°€íˆ ì œì–´í•´ì•¼ í•˜ëŠ” ê²½ìš°ì— ì í•©.
	â€¢	Spring Security ìë™í™” ì‚¬ìš©: í‘œì¤€ êµ¬í˜„ì´ ì¶©ë¶„í•œ ê²½ìš°ì—ëŠ” Spring Securityì˜ oauth2Loginì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” ê°„ë‹¨í•˜ê³  ë³´ì•ˆì ìœ¼ë¡œ ìœ ë¦¬.

a. ì‚¬ìš©ì ê¶Œí•œ(Role) ê¸°ë°˜ API ë³´í˜¸ ì¶”ê°€ ìš”ì²­.
b. Access Tokenì„ HttpOnly ì¿ í‚¤ë¡œ ì €ì¥í•˜ëŠ” ë³´ì•ˆ ê°•í™” ìš”ì²­.





IdAnywhereì™€ ê°™ì€ ê¸°ì—… ì¸ì¦/ì¸ê°€ í”Œë«í¼ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, OAuth2ë‚˜ SAMLê³¼ ê°™ì€ í”„ë¡œí† ì½œì„ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤. ëŒ€ë¶€ë¶„ì˜ IdAnywhere í”Œë«í¼ì€ OAuth2 ë˜ëŠ” OpenID Connect(OIDC)ë¥¼ ì§€ì›í•˜ë©°, Spring Bootì—ì„œ ì´ë¥¼ êµ¬í˜„í•˜ë ¤ë©´ ì•½ê°„ì˜ ë§ì¶¤ ì„¤ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì•„ë˜ëŠ” IdAnywhereë¥¼ Spring Bootì™€ í†µí•©í•˜ì—¬ Authorization Code Grant Flowë¥¼ êµ¬í˜„í•˜ëŠ” ì¼ë°˜ì ì¸ ë°©ë²•ì…ë‹ˆë‹¤. êµ¬ì²´ì ì¸ í”Œë«í¼ ì„¸ë¶€ ì‚¬í•­ì€ IdAnywhereì˜ ê³µì‹ ë¬¸ì„œë¥¼ ì°¸ê³ í•´ì•¼ í•©ë‹ˆë‹¤.

1. í™•ì¸í•´ì•¼ í•  ì‚¬í•­

	1.	IdAnywhereì—ì„œ ì œê³µí•˜ëŠ” ì¸ì¦ ë°©ì‹:
	â€¢	OAuth2 ë˜ëŠ” OpenID Connect(OIDC)ë¥¼ ì§€ì›í•˜ëŠ”ì§€ í™•ì¸.
	â€¢	Authorization Endpoint, Token Endpoint, UserInfo Endpoint ë“±ì˜ URL ì •ë³´ í™•ë³´.
	2.	í”Œë«í¼ì—ì„œ í´ë¼ì´ì–¸íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ë“±ë¡:
	â€¢	Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì„ IdAnywhereì— í´ë¼ì´ì–¸íŠ¸ë¡œ ë“±ë¡.
	â€¢	í´ë¼ì´ì–¸íŠ¸ IDì™€ í´ë¼ì´ì–¸íŠ¸ ë¹„ë°€(Client Secret) ë°œê¸‰.
	â€¢	Redirect URI ë“±ë¡ (ì˜ˆ: https://yourapp.com/login/oauth2/code/{registrationId}).
	3.	ì§€ì›í•˜ëŠ” ì¸ì¦ ë²”ìœ„:
	â€¢	OIDCì˜ ê²½ìš° openid, profile, email ë“±ì˜ Scopeë¥¼ ì„¤ì •.

2. Spring Boot OAuth2 ì„¤ì •

2.1 application.yml êµ¬ì„±

IdAnywhereì™€ ì—°ë™í•˜ê¸° ìœ„í•œ ì •ë³´ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.

spring:
  security:
    oauth2:
      client:
        registration:
          idanywhere:
            client-id: your-client-id
            client-secret: your-client-secret
            redirect-uri: "{baseUrl}/login/oauth2/code/idanywhere"
            authorization-grant-type: authorization_code
            scope: openid, profile, email
        provider:
          idanywhere:
            authorization-uri: https://idanywhere.example.com/oauth/authorize
            token-uri: https://idanywhere.example.com/oauth/token
            user-info-uri: https://idanywhere.example.com/oauth/userinfo
            user-name-attribute: sub

	â€¢	authorization-uri: IdAnywhereì˜ Authorization Endpoint URL.
	â€¢	token-uri: Access Tokenì„ ìš”ì²­í•˜ëŠ” Token Endpoint URL.
	â€¢	user-info-uri: ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” UserInfo Endpoint URL.
	â€¢	user-name-attribute: ì‚¬ìš©ì ê³ ìœ  ì‹ë³„ì í•„ë“œ(subëŠ” OpenID Connect í‘œì¤€).

2.2 Spring Security ì„¤ì •

Spring Securityë¥¼ êµ¬ì„±í•˜ì—¬ OAuth2 ì¸ì¦ê³¼ Access Token ì²˜ë¦¬ë¥¼ ìë™í™”í•©ë‹ˆë‹¤.

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable()) // CSRF ë¹„í™œì„±í™” (RESTful API)
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/", "/login", "/error").permitAll() // ê³µê°œ ê²½ë¡œ
                .anyRequest().authenticated() // ì¸ì¦ í•„ìš”
            )
            .oauth2Login(oauth2 -> oauth2
                .defaultSuccessUrl("/dashboard", true) // ì„±ê³µ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸
            );

        return http.build();
    }
}

3. Access Code â†’ Access Token ìˆ˜ë™ ì²˜ë¦¬ (í•„ìš” ì‹œ)

Spring Securityì˜ ê¸°ë³¸ OAuth2 Clientë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ , Access Token ì²˜ë¦¬ë¥¼ ìˆ˜ë™ìœ¼ë¡œ êµ¬í˜„í•´ì•¼ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

Access Token êµí™˜ API

import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;

import java.util.Map;

@RestController
@RequestMapping("/api/oauth")
public class OAuth2Controller {

    @Value("${spring.security.oauth2.client.registration.idanywhere.client-id}")
    private String clientId;

    @Value("${spring.security.oauth2.client.registration.idanywhere.client-secret}")
    private String clientSecret;

    @Value("${spring.security.oauth2.client.registration.idanywhere.redirect-uri}")
    private String redirectUri;

    @Value("${spring.security.oauth2.client.provider.idanywhere.token-uri}")
    private String tokenUri;

    private final RestTemplate restTemplate;

    public OAuth2Controller(RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
    }

    @PostMapping("/exchange-token")
    public ResponseEntity<Map<String, Object>> exchangeToken(@RequestBody Map<String, String> request) {
        String authorizationCode = request.get("code");

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);

        String body = String.format(
            "grant_type=authorization_code&code=%s&redirect_uri=%s&client_id=%s&client_secret=%s",
            authorizationCode, redirectUri, clientId, clientSecret
        );

        HttpEntity<String> httpEntity = new HttpEntity<>(body, headers);

        ResponseEntity<Map> response = restTemplate.exchange(
                tokenUri,
                HttpMethod.POST,
                httpEntity,
                Map.class
        );

        return ResponseEntity.ok(response.getBody()); // Access Token ë°˜í™˜
    }
}

4. ì‚¬ìš©ì ì •ë³´ ìš”ì²­

Access Tokenì„ ì‚¬ìš©í•´ IdAnywhereì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.

ì‚¬ìš©ì ì •ë³´ API

import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;

import java.util.Map;

@RestController
@RequestMapping("/api/user")
public class UserInfoController {

    @Value("${spring.security.oauth2.client.provider.idanywhere.user-info-uri}")
    private String userInfoUri;

    private final RestTemplate restTemplate;

    public UserInfoController(RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
    }

    @GetMapping
    public ResponseEntity<Map<String, Object>> getUserInfo(@RequestHeader("Authorization") String authorizationHeader) {
        HttpHeaders headers = new HttpHeaders();
        headers.set("Authorization", authorizationHeader);

        HttpEntity<String> httpEntity = new HttpEntity<>(headers);

        ResponseEntity<Map> response = restTemplate.exchange(
                userInfoUri,
                HttpMethod.GET,
                httpEntity,
                Map.class
        );

        return ResponseEntity.ok(response.getBody());
    }
}

5. í”„ë¡ íŠ¸ì—”ë“œ: ì¸ì¦ ìš”ì²­ ë° ì²˜ë¦¬

ë¡œê·¸ì¸ ìš”ì²­

Reactì—ì„œ IdAnywhereì˜ Authorization Endpointë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•©ë‹ˆë‹¤.

export const redirectToLogin = () => {
  const clientId = "your-client-id";
  const redirectUri = encodeURIComponent("http://localhost:8080/login/oauth2/code/idanywhere");
  const authorizationUrl = `https://idanywhere.example.com/oauth/authorize?response_type=code&client_id=${clientId}&redirect_uri=${redirectUri}&scope=openid profile email`;

  window.location.href = authorizationUrl;
};

Access Code ì²˜ë¦¬

Redirect URIì—ì„œ Access Codeë¥¼ ì¶”ì¶œí•˜ê³  ë°±ì—”ë“œì— ì „ë‹¬í•©ë‹ˆë‹¤.

import axios from 'axios';

export const handleOAuthCallback = async () => {
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');

  if (code) {
    try {
      const response = await axios.post('/api/oauth/exchange-token', { code });
      const { access_token } = response.data;

      // Access Token ì €ì¥
      localStorage.setItem('accessToken', access_token);

      // ì‚¬ìš©ì ì •ë³´ ìš”ì²­
      const userInfo = await axios.get('/api/user', {
        headers: {
          Authorization: `Bearer ${access_token}`,
        },
      });

      console.log(userInfo.data);
    } catch (error) {
      console.error('OAuth callback error:', error);
    }
  } else {
    console.error('Authorization code not found');
  }
};

ìš”ì•½

	1.	IdAnywhere ì„¤ì •:
	â€¢	í´ë¼ì´ì–¸íŠ¸ ID, ë¹„ë°€ í‚¤, Redirect URI, Endpoints ì„¤ì •.
	2.	Spring Boot:
	â€¢	Spring Security OAuth2 Clientë¥¼ í†µí•´ Authorization Code Grant Flow ì„¤ì •.
	â€¢	Access Code ì²˜ë¦¬ ë° Access Token ìš”ì²­ êµ¬í˜„.
	3.	í”„ë¡ íŠ¸ì—”ë“œ:
	â€¢	OAuth2 Authorization Endpointë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸.
	â€¢	Access Codeë¥¼ ë°±ì—”ë“œë¡œ ì „ë‹¬í•˜ê³  Access Token ë° ì‚¬ìš©ì ì •ë³´ ìš”ì²­.

a. Refresh Tokenìœ¼ë¡œ Access Token ê°±ì‹  ë¡œì§ ì¶”ê°€ ìš”ì²­.
b. ì‚¬ìš©ì ì—­í• (Role) ê¸°ë°˜ ì ‘ê·¼ ì œì–´ ë¡œì§ êµ¬í˜„ ìš”ì²­.

Access Tokenì„ í†µí•´ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¸ì¦í•˜ê³ , ì´ë¥¼ í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œì—ì„œ í™œìš©í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤. íŠ¹íˆ, Access Tokenì„ íŒŒì‹±í•˜ì—¬ ì‚¬ìš©ì ì´ë¦„, ì´ë©”ì¼, ì—­í• (role) ë“±ì˜ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ëŠ” ë°©ë²•ì„ ë‹¤ë£¨ê² ìŠµë‹ˆë‹¤. JWT(JSON Web Token)ë¥¼ Access Tokenìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, ì´ë¥¼ í†µí•´ ì†ì‰½ê²Œ ì¸ì¦ ë° ì •ë³´ë¥¼ ì¶”ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

1. Access Tokenì„ Certificateë¡œ ë¶„í•´í•˜ì—¬ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ (ë°±ì—”ë“œ)

Access Tokenì´ JWT í˜•ì‹ì´ë¼ë©´, ì´ë¥¼ ë””ì½”ë”©í•˜ì—¬ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¶”ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Spring Bootì—ì„œ JWTë¥¼ íŒŒì‹±í•˜ë ¤ë©´ java-jwt ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°„ë‹¨í•˜ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

1.1 JWT í† í°ì„ íŒŒì‹±í•˜ì—¬ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ

import com.auth0.jwt.JWT;
import com.auth0.jwt.algorithms.Algorithm;
import com.auth0.jwt.interfaces.DecodedJWT;
import org.springframework.stereotype.Service;
import java.util.Map;

@Service
public class TokenParserService {

    private final String SECRET_KEY = "your-secret-key"; // ì‹¤ì œ í‚¤ë¡œ ëŒ€ì²´í•´ì•¼ í•¨

    public Map<String, String> parseToken(String accessToken) {
        DecodedJWT jwt = JWT.require(Algorithm.HMAC256(SECRET_KEY))
                            .build()
                            .verify(accessToken);

        String username = jwt.getClaim("name").asString();
        String email = jwt.getClaim("email").asString();
        String role = jwt.getClaim("role").asString();

        return Map.of(
            "name", username,
            "email", email,
            "role", role
        );
    }
}

ìœ„ì˜ ì½”ë“œì—ì„œëŠ” java-jwt ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ Access Tokenì„ ë””ì½”ë”©í•©ë‹ˆë‹¤. JWTê°€ ê²€ì¦ë˜ë©´ name, email, role ë“±ì˜ í´ë ˆì„ ì •ë³´ë¥¼ ì¶”ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

1.2 TokenParserServiceë¥¼ í†µí•´ ì‚¬ìš©ì ì •ë³´ í™œìš©

ì´ì œ TokenParserServiceë¥¼ ì‚¬ìš©í•´ íŒŒì‹±ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ì–»ê³ , ì´ ì •ë³´ë¥¼ API ì‘ë‹µìœ¼ë¡œ ì œê³µí•˜ê±°ë‚˜ í•„ìš”í•œ ì¸ì¦ ë° ì¸ê°€ ë¡œì§ì— ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RestController;
import java.util.Map;

@RestController
public class UserInfoController {

    private final TokenParserService tokenParserService;

    public UserInfoController(TokenParserService tokenParserService) {
        this.tokenParserService = tokenParserService;
    }

    @GetMapping("/api/userinfo")
    public Map<String, String> getUserInfo(@RequestHeader("Authorization") String token) {
        String accessToken = token.replace("Bearer ", "");
        return tokenParserService.parseToken(accessToken);
    }
}

ì´ì œ /api/userinfo ì—”ë“œí¬ì¸íŠ¸ëŠ” Access Tokenì„ ë°›ì•„ ì‚¬ìš©ì ì´ë¦„, ì´ë©”ì¼, ì—­í•  ì •ë³´ë¥¼ í´ë¼ì´ì–¸íŠ¸ì— ë°˜í™˜í•©ë‹ˆë‹¤.

2. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ Access Token ë¡œê·¸ì¸ ë° ì‚¬ìš©ì ì •ë³´ ìš”ì²­ (React)

í”„ë¡ íŠ¸ì—”ë“œì—ì„œëŠ” ë°±ì—”ë“œì—ì„œ ë°œê¸‰ëœ Access Tokenì„ localStorageì— ì €ì¥í•˜ì—¬ ì¸ì¦ì— ì‚¬ìš©í•˜ê³ , í•„ìš”í•œ ê²½ìš° /api/userinfo ì—”ë“œí¬ì¸íŠ¸ë¥¼ í†µí•´ ì‚¬ìš©ì ì •ë³´ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.

2.1 Access Token ë°œê¸‰ ë° ì €ì¥

// authService.js
import axios from 'axios';

export const loginWithToken = async (username, password) => {
  try {
    const response = await axios.post('/api/login', { username, password });
    const accessToken = response.data.accessToken;
    localStorage.setItem('accessToken', accessToken);
    return accessToken;
  } catch (error) {
    console.error('Login failed:', error);
    throw error;
  }
};

ìœ„ì˜ ì½”ë“œì—ì„œ /api/login ì—”ë“œí¬ì¸íŠ¸ë¥¼ í†µí•´ ì‚¬ìš©ì ì¸ì¦ì„ ìš”ì²­í•˜ê³ , ì‘ë‹µìœ¼ë¡œ ë°›ì€ Access Tokenì„ localStorageì— ì €ì¥í•©ë‹ˆë‹¤.

2.2 Access Tokenì„ ì´ìš©í•´ ì‚¬ìš©ì ì •ë³´ ìš”ì²­

// userService.js
import axios from 'axios';

export const fetchUserInfo = async () => {
  const token = localStorage.getItem('accessToken');
  try {
    const response = await axios.get('/api/userinfo', {
      headers: {
        Authorization: `Bearer ${token}`,
      },
    });
    return response.data;
  } catch (error) {
    console.error('Error fetching user info:', error);
    throw error;
  }
};

ì´ì œ fetchUserInfo í•¨ìˆ˜ëŠ” Access Tokenì„ Authorization í—¤ë”ì— í¬í•¨í•˜ì—¬ /api/userinfo ì—”ë“œí¬ì¸íŠ¸ì— ìš”ì²­ì„ ë³´ë‚´ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

2.3 React ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©ì ì •ë³´ ë Œë”ë§

React ì»´í¬ë„ŒíŠ¸ì—ì„œ fetchUserInfo í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°›ì•„ì™€ í‘œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

import React, { useEffect, useState } from 'react';
import { fetchUserInfo } from './userService';

const UserProfile = () => {
  const [userInfo, setUserInfo] = useState(null);

  useEffect(() => {
    const getUserInfo = async () => {
      try {
        const data = await fetchUserInfo();
        setUserInfo(data);
      } catch (error) {
        console.error('Failed to load user info', error);
      }
    };
    getUserInfo();
  }, []);

  if (!userInfo) {
    return <div>Loading...</div>;
  }

  return (
    <div>
      <h1>User Profile</h1>
      <p>Name: {userInfo.name}</p>
      <p>Email: {userInfo.email}</p>
      <p>Role: {userInfo.role}</p>
    </div>
  );
};

export default UserProfile;

ì´ ì»´í¬ë„ŒíŠ¸ëŠ” useEffect í›…ì„ ì‚¬ìš©í•´ fetchUserInfoë¥¼ í˜¸ì¶œí•˜ì—¬ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì™€ ìƒíƒœë¡œ ê´€ë¦¬í•˜ê³ , ë Œë”ë§ ì‹œ userInfoì˜ ê° í•„ë“œë¥¼ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.

ìš”ì•½

	â€¢	ë°±ì—”ë“œ: RestTemplateì„ ì‚¬ìš©í•´ Access Tokenì„ ë°œê¸‰ë°›ì•„ í—¤ë”ì— ì¶”ê°€í•˜ì—¬ ìš”ì²­í•˜ê³ , JWTë¥¼ íŒŒì‹±í•˜ì—¬ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¶”ì¶œ.
	â€¢	í”„ë¡ íŠ¸ì—”ë“œ: Access Tokenì„ localStorageì— ì €ì¥í•˜ì—¬ ì¸ì¦ì— ì‚¬ìš©í•˜ê³ , ë°±ì—”ë“œì˜ /api/userinfo ì—”ë“œí¬ì¸íŠ¸ë¥¼ í†µí•´ ì‚¬ìš©ì ì •ë³´ë¥¼ ìš”ì²­í•˜ê³  í‘œì‹œ.

a. Access Token ë§Œë£Œ ì‹œ ìë™ ì¬ë°œê¸‰ ê¸°ëŠ¥ ì¶”ê°€
b. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì‚¬ìš©ì ì •ë³´ì˜ ë³´ì•ˆì„ ìœ„í•œ ì¶”ê°€ ì „ëµ





ì‚¬ìš©ìê°€ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ í˜¸ì¶œí•  ë•Œ ë‚ ì§œ, ì‹œê°„, ì‚¬ìš©ì ID, í˜¸ì¶œí•œ API ì£¼ì†Œ ë“±ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ê¸°ë¡í•˜ë ¤ë©´, AOP(Aspect-Oriented Programming)ë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  API í˜¸ì¶œì— ëŒ€í•œ ë¡œê¹…ì„ ì¤‘ì•™ ì§‘ì¤‘í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì½”ë“œ ì¤‘ë³µì„ ì¤„ì´ê³ , í•„ìš”í•œ ëª¨ë“  ì •ë³´ê°€ ë°ì´í„°ë² ì´ìŠ¤ì— ê¸°ë¡ë˜ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 1. ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ì„¤ê³„

ë¨¼ì €, ë¡œê·¸ë¥¼ ê¸°ë¡í•  ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì„ ì„¤ê³„í•´ì•¼ í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë‹¤ìŒê³¼ ê°™ì€ í…Œì´ë¸”ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### SQL ìŠ¤í¬ë¦½íŠ¸

```sql
CREATE TABLE api_call_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(255),
    api_url VARCHAR(255),
    http_method VARCHAR(10),
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    request_data TEXT
);
```

ì´ í…Œì´ë¸”ì€ API í˜¸ì¶œì˜ ID, ì‚¬ìš©ì ID, í˜¸ì¶œí•œ APIì˜ URL, HTTP ë©”ì„œë“œ, í˜¸ì¶œ ì‹œê°„, ê·¸ë¦¬ê³  ìš”ì²­ ë°ì´í„°ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.

### 2. AOPë¥¼ ì‚¬ìš©í•œ ë¡œê¹… êµ¬í˜„

ì´ì œ Spring AOPë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ì»¨íŠ¸ë¡¤ëŸ¬ í˜¸ì¶œì„ ê°€ë¡œì±„ê³ , í•„ìš”í•œ ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ê¸°ë¡í•˜ëŠ” ë¡œì§ì„ ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤.

#### 2.1. ë¡œê¹… ì„œë¹„ìŠ¤ ì‘ì„±

ë¨¼ì €, API í˜¸ì¶œ ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ëŠ” `LoggingService`ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

```java
import org.springframework.stereotype.Service;
import org.springframework.beans.factory.annotation.Autowired;

@Service
public class LoggingService {

    private final ApiCallLogRepository apiCallLogRepository;

    @Autowired
    public LoggingService(ApiCallLogRepository apiCallLogRepository) {
        this.apiCallLogRepository = apiCallLogRepository;
    }

    public void logApiCall(String userId, String apiUrl, String httpMethod, String requestData) {
        ApiCallLog log = new ApiCallLog(userId, apiUrl, httpMethod, requestData);
        apiCallLogRepository.save(log);
    }
}
```

#### 2.2. AOP ì• ìŠ¤í™íŠ¸ ì‘ì„±

ì´ì œ AOPë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ì»¨íŠ¸ë¡¤ëŸ¬ í˜¸ì¶œì„ ê°€ë¡œì±„ëŠ” `LoggingAspect`ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

```java
import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.annotation.AfterReturning;
import org.aspectj.lang.annotation.Aspect;
import org.springframework.stereotype.Component;
import javax.servlet.http.HttpServletRequest;
import org.aspectj.lang.annotation.Before;
import org.aspectj.lang.annotation.Pointcut;

@Component
@Aspect
public class LoggingAspect {

    private final LoggingService loggingService;
    private final HttpServletRequest request;

    public LoggingAspect(LoggingService loggingService, HttpServletRequest request) {
        this.loggingService = loggingService;
        this.request = request;
    }

    @Pointcut("within(@org.springframework.web.bind.annotation.RestController *)")
    public void controllerMethods() {}

    @AfterReturning("controllerMethods()")
    public void logAfter(JoinPoint joinPoint) {
        String userId = request.getHeader("User-ID");  // í—¤ë”ì—ì„œ ì‚¬ìš©ì ID ì¶”ì¶œ, ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œë„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ
        String apiUrl = request.getRequestURI();  // í˜¸ì¶œëœ API URL
        String httpMethod = request.getMethod();  // HTTP ë©”ì„œë“œ(GET, POST ë“±)
        String requestData = request.getQueryString();  // ìš”ì²­ íŒŒë¼ë¯¸í„°ë“¤

        loggingService.logApiCall(userId, apiUrl, httpMethod, requestData);
    }
}
```

ìœ„ ì½”ë“œì—ì„œ:

- `@Pointcut("within(@org.springframework.web.bind.annotation.RestController *)")`: ëª¨ë“  `@RestController` í´ë˜ìŠ¤ì— ì •ì˜ëœ ë©”ì„œë“œë“¤ì´ ì´ í¬ì¸íŠ¸ì»·ì— í¬í•¨ë©ë‹ˆë‹¤.
- `@AfterReturning("controllerMethods()")`: ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì„œë“œê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ëœ í›„ì— ë¡œê¹…ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤.
- `HttpServletRequest`: Springì´ ì œê³µí•˜ëŠ” HTTP ìš”ì²­ ê°ì²´ë¡œ, ì´ë¥¼ í†µí•´ API URL, HTTP ë©”ì„œë“œ, ìš”ì²­ ë°ì´í„° ë“±ì„ ì¶”ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- `logApiCall`: `LoggingService`ë¥¼ ì‚¬ìš©í•´ ë¡œê·¸ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•©ë‹ˆë‹¤.

#### 2.3. API í˜¸ì¶œ ë¡œê·¸ ì—”í‹°í‹° ë° ë ˆí¬ì§€í† ë¦¬ ì‘ì„±

ë¡œê·¸ ë°ì´í„°ë¥¼ ì €ì¥í•  ì—”í‹°í‹°ì™€ ë ˆí¬ì§€í† ë¦¬ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

##### ì—”í‹°í‹° í´ë˜ìŠ¤

```java
import javax.persistence.*;

@Entity
public class ApiCallLog {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String userId;
    private String apiUrl;
    private String httpMethod;
    private String requestData;

    @Column(nullable = false, updatable = false)
    private Timestamp timestamp;

    public ApiCallLog(String userId, String apiUrl, String httpMethod, String requestData) {
        this.userId = userId;
        this.apiUrl = apiUrl;
        this.httpMethod = httpMethod;
        this.requestData = requestData;
        this.timestamp = new Timestamp(System.currentTimeMillis());
    }

    // ê¸°ë³¸ ìƒì„±ì, ê²Œí„° ë° ì„¸í„° ìƒëµ
}
```

##### ë ˆí¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤

```java
import org.springframework.data.jpa.repository.JpaRepository;

public interface ApiCallLogRepository extends JpaRepository<ApiCallLog, Long> {
}
```

### 3. ì „ì²´ íë¦„ ìš”ì•½

1. **ì‚¬ìš©ìê°€ API í˜¸ì¶œ**: ì‚¬ìš©ìê°€ ì»¨íŠ¸ë¡¤ëŸ¬ì— ì •ì˜ëœ APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
2. **AOP ì• ìŠ¤í™íŠ¸ê°€ í˜¸ì¶œì„ ê°€ë¡œì±”**: AOPê°€ ì´ í˜¸ì¶œì„ ê°€ë¡œì±„ì–´ í•„ìš”í•œ ì •ë³´ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
3. **ë¡œê·¸ ì €ì¥**: `LoggingService`ë¥¼ í†µí•´ ì¶”ì¶œí•œ ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•©ë‹ˆë‹¤.
4. **ì»¨íŠ¸ë¡¤ëŸ¬ ì •ìƒ ì‹¤í–‰**: AOP ì• ìŠ¤í™íŠ¸ê°€ ì‹¤í–‰ëœ í›„, ì»¨íŠ¸ë¡¤ëŸ¬ ë¡œì§ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.

### ê²°ë¡ 

ì´ ë°©ì‹ìœ¼ë¡œ, ì‚¬ìš©ìê°€ APIë¥¼ í˜¸ì¶œí•  ë•Œë§ˆë‹¤ ê´€ë ¨ ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ì— ê¸°ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. AOPë¥¼ ì‚¬ìš©í•˜ë©´ ì´ëŸ¬í•œ ë¡œê¹… ë¡œì§ì„ ê°œë³„ ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì„œë“œì— ë°˜ë³µì ìœ¼ë¡œ ì‘ì„±í•  í•„ìš”ê°€ ì—†ìœ¼ë¯€ë¡œ ì½”ë“œì˜ ê°„ê²°ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì„±ì„ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ, ë¡œê¹… ì´ì™¸ì˜ íš¡ë‹¨ ê´€ì‹¬ì‚¬ì—ë„ AOPë¥¼ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.